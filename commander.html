<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Commander - La Ruche Gourmande</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fff8e1; color:#333; padding:20px; margin-bottom:60px;}
h1{color:#f4b41a;}
table{width:100%; border-collapse:collapse; margin-top:20px;}
th, td{border:1px solid #ccc; padding:10px; text-align:center;}
th{background:#f4b41a; color:white;}
tfoot td{font-weight:bold;}
.btn{padding:10px 20px; margin-top:15px; border:none; border-radius:6px; cursor:pointer; color:white; font-weight:bold;}
.btn-clear{background:#e74c3c;}
.btn-checkout{background:#27ae60;}
form{margin-top:30px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
input, textarea, select{width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc;}
#map{width:100%; height:350px; margin-top:20px; border-radius:12px;}
#backBtn{position:fixed; bottom:10px; left:50%; transform:translateX(-50%); background:#f4b41a; color:white; padding:12px 25px; border-radius:8px; font-weight:bold; text-decoration:none; z-index:1000;}
#paypal-button-container{margin-top:15px;}
</style>
</head>
<body>

<h1>Votre Panier</h1>

<table id="cartTable">
  <thead>
    <tr>
      <th>Produit</th>
      <th>Format</th>
      <th>Quantité</th>
      <th>Prix unitaire</th>
      <th>Total</th>
      <th>Supprimer</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">Total général</td>
      <td id="grandTotal">0€</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button class="btn btn-clear" id="clearCart">Vider le panier</button>

<h2>Informations de livraison</h2>

<form id="orderForm" action="https://formspree.io/f/xyzdzwwj" method="POST">
  <label>Prénom :</label>
  <input type="text" name="Prénom" id="fname" required />
  <label>Nom :</label>
  <input type="text" name="Nom" id="lname" required />

  <label>Email :</label>
  <input type="email" name="Email" id="email" />
  <label>Téléphone :</label>
  <input type="tel" name="Téléphone" id="phone" />

  <label>Préférence de contact :</label>
  <select name="ContactPreference" id="contactPreference" required>
    <option value="">-- Choisissez --</option>
    <option value="email">Email</option>
    <option value="téléphone">Téléphone</option>
  </select>

  <label>Adresse complète :</label>
  <input type="text" name="Adresse" id="address" placeholder="Ex : 12 Rue des Abeilles, Villerupt" required />
  <p id="deliveryStatus" style="font-size:0.95rem; color:#555; margin-top:5px;"></p>
  <label>Compléments (optionnel) :</label>
  <textarea name="Compléments" id="details"></textarea>

  <label>Choisissez votre option :</label>
  <select name="Option" id="pickupOption" required>
    <option value="retrait">Je viens chercher ma commande à la Ruche Gourmande (sur rendez-vous)</option>
    <option value="livraison">Livraison gratuite samedi (zone < 15 km)</option>
  </select>
  <p style="font-size:0.95rem; color:#555; margin-top:5px;">
  ⚠️ Retrait à la Ruche Gourmande uniquement sur rendez-vous afin que nous puissions vous accueillir et vous servir au mieux.
  </p>

  <input type="hidden" name="Panier" id="cartData" />
  <button type="submit" class="btn btn-checkout" id="submitOrderBtn">Passer commande</button>
</form>

<div id="paypal-button-container" style="display:none;"></div>

<div id="map"></div>
<a href="index.html" id="backBtn">Retour au site</a>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=AVOuGR4lIpZHx31FOq9QgyAL-XozrTtpsGvUaN-nitxJpLkkUa-8oxnivbiZO-WbN9jRSvQcbO47cCVD&currency=EUR"></script>

<script>
// --- Panier ---
function loadCart() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';
  let grandTotal = 0;
  cart.forEach((item, index) => {
    const total = item.qty * item.price;
    grandTotal += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item.name}</td><td>${item.size} g</td><td>${item.qty}</td><td>${item.price}€</td><td>${total}€</td><td><button type="button" onclick="removeItem(${index})">❌</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('grandTotal').textContent = grandTotal + '€';
  document.getElementById('cartData').value = JSON.stringify(cart);
  return {cart, grandTotal};
}

function removeItem(index){
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  cart.splice(index,1);
  localStorage.setItem('cart',JSON.stringify(cart));
  loadCart();
}

document.getElementById('clearCart').addEventListener('click', ()=>{
  localStorage.removeItem('cart');
  loadCart();
});

loadCart();

// --- Carte ---
const rucheCoords = { lat: 49.4604210515537, lon: 5.937996326094758 };
const maxDistanceKm = 15;
let map = null;

function initMap() {
  map = L.map('map').setView([rucheCoords.lat, rucheCoords.lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap'}).addTo(map);

  L.circle([rucheCoords.lat, rucheCoords.lon], {
    radius: maxDistanceKm*1000,
    color: 'green',
    fillColor: 'green',
    fillOpacity: 0.2
  }).addTo(map).bindPopup("Zone de livraison gratuite (samedi)").openPopup();

  L.marker([rucheCoords.lat, rucheCoords.lon]).addTo(map).bindPopup('La Ruche Gourmande').openPopup();
}

initMap();

// --- Formulaire et livraison dynamique ---
async function getCoordsFromAddress(address){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    if(data && data.length > 0){
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }
  } catch(e){
    console.error("Erreur API Nominatim :", e);
  }
  return null;
}

function haversineDistance(lat1, lon1, lat2, lon2){
  const R = 6371; // km
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

const addressInput = document.getElementById('address');
const deliveryStatus = document.getElementById('deliveryStatus');
let timeout = null;

addressInput.addEventListener('input', ()=>{
  clearTimeout(timeout);
  deliveryStatus.textContent = "⏳ Vérification de la livraison…";
  deliveryStatus.style.color = "#555";

  timeout = setTimeout(async () => {
    const address = addressInput.value.trim();
    const pickupOption = document.getElementById('pickupOption');

    if(address === "") {
      deliveryStatus.textContent = "";
      pickupOption.disabled = false;
      return;
    }

    const coords = await getCoordsFromAddress(address);
    if(!coords){
      deliveryStatus.textContent = "Impossible de vérifier la livraison pour cette adresse.";
      deliveryStatus.style.color = "orange";
      pickupOption.disabled = false;
      return;
    }

    const distance = haversineDistance(coords.lat, coords.lon, rucheCoords.lat, rucheCoords.lon);

    if(distance <= maxDistanceKm){
      deliveryStatus.textContent = `✅ Livraison possible (distance : ${distance.toFixed(1)} km). Vous pouvez choisir livraison ou retrait.`;
      deliveryStatus.style.color = "green";
      pickupOption.disabled = false; // choix libre
    } else {
      deliveryStatus.textContent = `❌ Livraison impossible (distance : ${distance.toFixed(1)} km). Votre commande sera à retirer à la Ruche Gourmande.`;
      deliveryStatus.style.color = "red";
      pickupOption.value = "retrait"; // forcer retrait
      pickupOption.disabled = true;
    }
  }, 700);
});

// --- PayPal & bouton ---
const paypalContainer = document.getElementById('paypal-button-container');
const submitOrderBtn = document.getElementById('submitOrderBtn');
const orderForm = document.getElementById('orderForm');

function hasPackIA(cart){
  return cart.some(item => item.name.toLowerCase().includes('pack ia'));
}
function onlyHoney(cart){
  if(cart.length === 0) return false;
  return cart.every(item => item.name.toLowerCase().includes('miel'));
}

function updateButtons() {
  const {cart, grandTotal} = loadCart();

  if(cart.length === 0){
    paypalContainer.style.display = 'none';
    submitOrderBtn.style.display = 'none';
    return;
  }

  if(hasPackIA(cart)) {
    // Paiement en ligne obligatoire
    paypalContainer.style.display = 'block';
    submitOrderBtn.style.display = 'none';
  } else if(onlyHoney(cart)) {
    // Paiement en ligne possible + paiement à réception
    paypalContainer.style.display = 'block';
    submitOrderBtn.style.display = 'inline-block';
    submitOrderBtn.textContent = 'Paiement à la réception';
  } else {
    // Panier mixte sans pack IA (tu dis pas possible, mais au cas où)
    paypalContainer.style.display = 'none';
    submitOrderBtn.style.display = 'inline-block';
    submitOrderBtn.textContent = 'Paiement à la réception';
  }
}

// Initial update buttons
updateButtons();

// Recharger les boutons à chaque modification du panier
window.addEventListener('storage', updateButtons);
document.getElementById('clearCart').addEventListener('click', updateButtons);
document.querySelector('#cartTable tbody').addEventListener('click', updateButtons);

// --- PayPal buttons init ---
paypal.Buttons({
  createOrder: function(data, actions) {
    const {cart, grandTotal} = loadCart();
    return actions.order.create({
      purchase_units: [{
        amount: {
          value: grandTotal.toFixed(2)
        }
      }]
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
      // Envoyer la commande avec infos client + paiement validé
      const formData = new FormData(orderForm);
      formData.append('PayPalOrderID', details.id);
      formData.append('PayPalPayer', details.payer.email_address);

      fetch(orderForm.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      }).then(response => {
        if(response.ok){
          localStorage.removeItem('cart');
          loadCart();
          orderForm.reset();
          window.location.href = "confirmation.html";
        } else {
          alert("Erreur lors de l'envoi de la commande.");
        }
      });
    });
  },
  onError: function(err){
    alert('Erreur PayPal : ' + err);
  }
}).render('#paypal-button-container');

// --- Soumission formulaire (paiement à réception) ---
orderForm.addEventListener('submit', function(e){
  e.preventDefault();
  const {cart} = loadCart();

  if(hasPackIA(cart)){
    alert("Le pack IA doit être payé en ligne via PayPal.");
    return;
  }

  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const contactPreference = document.getElementById('contactPreference').value;
  const address = document.getElementById('address').value.trim();

  if(contactPreference === "email" && email === ""){
    alert("Vous avez choisi 'Email' comme préférence de contact. Merci de renseigner votre adresse email.");
    return;
  }
  if(contactPreference === "téléphone" && phone === ""){
    alert("Vous avez choisi 'Téléphone' comme préférence de contact. Merci de renseigner votre numéro de téléphone.");
    return;
  }

  const regexAdresse = /^[0-9]+.*[a-zA-Zéèàùâêîôûç\s]+.*[a-zA-Zéèàùâêîôûç\s]+$/;
  if(!regexAdresse.test(address)){
    alert("Veuillez entrer une adresse complète et précise : numéro, rue et ville.");
    return;
  }

  // Envoi commande "paiement à la réception"
  fetch(orderForm.action, {
    method: 'POST',
    body: new FormData(orderForm),
    headers: { 'Accept': 'application/json' }
  }).then(response => {
    if(response.ok){
      localStorage.removeItem('cart');
      loadCart();
      orderForm.reset();
      window.location.href = "confirmation.html";
    } else {
      alert("Erreur lors de l'envoi de la commande.");
    }
  });
});
</script>

</body>
</html>