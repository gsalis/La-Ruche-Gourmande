<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panier - La Ruche Gourmande</title>
<style>
  body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#fff8e1; color:#333; padding:20px;}
  h1{color:#f4b41a;}
  table{width:100%; border-collapse:collapse; margin-top:20px;}
  th, td{border:1px solid #ccc; padding:10px; text-align:center;}
  th{background:#f4b41a; color:white;} tfoot td{font-weight:bold;}
  .btn{padding:10px 20px; margin-top:15px; border:none; border-radius:6px; cursor:pointer; color:white; font-weight:bold;}
  .btn-clear{background:#e74c3c;}
  .btn-checkout{background:#27ae60;}
  form{margin-top:30px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  input, textarea{width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc;}
  #message{margin-top:20px; font-weight:bold;}
  #map{width:100%; height:300px; margin-top:20px; border-radius:12px;}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>

<h1>Votre Panier</h1>

<table id="cartTable">
  <thead>
    <tr>
      <th>Produit</th>
      <th>Format</th>
      <th>Quantité</th>
      <th>Prix unitaire</th>
      <th>Total</th>
      <th>Supprimer</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">Total général</td>
      <td id="grandTotal">0€</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button class="btn btn-clear" id="clearCart">Vider le panier</button>

<h2>Informations de livraison</h2>
<form id="orderForm">
  <label>Prénom :</label>
  <input type="text" id="fname" required>
  <label>Nom :</label>
  <input type="text" id="lname" required>
  <label>Adresse :</label>
  <input type="text" id="address" placeholder="Rue, Code Postal, Ville" required>
  <label>Compléments (optionnel) :</label>
  <textarea id="details"></textarea>
  <button type="submit" class="btn btn-checkout">Passer commande</button>
</form>

<div id="message"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Panier ---
function loadCart() {
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  const tbody = document.querySelector('#cartTable tbody');
  tbody.innerHTML = '';
  let grandTotal = 0;
  cart.forEach((item, index) => {
    const total = item.qty * item.price;
    grandTotal += total;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${item.name}</td><td>${item.size} g</td><td>${item.qty}</td><td>${item.price}€</td><td>${total}€</td><td><button onclick="removeItem(${index})">❌</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('grandTotal').textContent = grandTotal + '€';
}

function removeItem(index){
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  cart.splice(index,1);
  localStorage.setItem('cart',JSON.stringify(cart));
  loadCart();
}

document.getElementById('clearCart').addEventListener('click', ()=>{
  localStorage.removeItem('cart');
  loadCart();
});

loadCart();

// --- Livraison ---
const rucheAddress = "3 rue Maximilien de Robespierre, Villerupt";
const maxDistanceKm = 15;
let rucheCoords = null;

// Obtenir coordonnées de la ruche
async function getRucheCoords(){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(rucheAddress)}`);
  const data = await res.json();
  rucheCoords = {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon)};
  // Initialiser carte Leaflet
  const map = L.map('map').setView([rucheCoords.lat, rucheCoords.lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'© OpenStreetMap'}).addTo(map);
  L.circle([rucheCoords.lat, rucheCoords.lon], {radius:maxDistanceKm*1000, color:'green', fillOpacity:0.2}).addTo(map);
  L.marker([rucheCoords.lat, rucheCoords.lon]).addTo(map).bindPopup('La Ruche Gourmande').openPopup();
}
getRucheCoords();

function deg2rad(deg){return deg*(Math.PI/180);}
function getDistance(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=deg2rad(lat2-lat1);
  const dLon=deg2rad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

async function geocode(address){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
  const data = await res.json();
  if(data.length===0) return null;
  return {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon)};
}

function showMessage(msg, type){
  const m = document.getElementById('message');
  m.textContent = msg;
  m.style.color = (type==='success')?'green':'red';
}

// --- Formulaire ---
document.getElementById('orderForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const cart = JSON.parse(localStorage.getItem('cart')) || [];
  if(cart.length===0){
    showMessage('Votre panier est vide !','error');
    return;
  }
  const address = document.getElementById('address').value;
  const coords = await geocode(address);
  if(!coords){
    showMessage('Adresse introuvable, merci de vérifier.','error');
    return;
  }
  const distance = getDistance(rucheCoords.lat, rucheCoords.lon, coords.lat, coords.lon);
  let deliveryMessage='';
  if(distance <= maxDistanceKm){
    deliveryMessage = 'Livraison gratuite le samedi dans votre zone !';
  } else {
    deliveryMessage = 'Vous êtes hors de la zone, retrait à la Ruche Gourmande.';
  }

  localStorage.removeItem('cart');
  loadCart();
  document.getElementById('orderForm').reset();
  showMessage(`Merci ${document.getElementById('fname').value} ! Votre commande est confirmée. ${deliveryMessage}`,'success');
});
</script>

</body>
</html>
